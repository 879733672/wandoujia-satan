<section class="wdj-messages">
    <div class="wdm-layout">
        <section class="wdm-sub">
            <section class="wdm-actions">
                <div class="btn btn-primary"
                    ng-click="createConversation();$root.GA('messages:create')"><i class="messages-icon-ab-add"></i> {{$root.DICT.messages.ACTION_NEW}}</div>
                <div class="btn"
                    ng-click="toggleSelectedAll();$root.GA('messages:select_all:' + isSelectedAll())"
                    ng-switch on="isSelectedAll()">
                    <i class="messages-icon-ab-sel"></i>
                    <span ng-switch-when="false">{{$root.DICT.messages.ACTION_SELECT_ALL}}</span>
                    <span ng-switch-when="true">{{$root.DICT.messages.ACTION_DESELECT_ALL}}</span>
                </div>
                <div class="btn"
                    ng-click="removeSelected();$root.GA('messages:delete_conversation')"
                    ng-show="hasSelected()"><i class="messages-icon-ab-del"></i> {{$root.DICT.messages.ACTION_DELETE}}</div>
            </section>
            <ol class="wdm-conversations unstyled">
                <li class="wdmc-row"
                    ng-repeat="c in conversations"
                    ng-init="status=cvsCache.get(c)"
                    ng-class="{ selected: status.selected, highlight: status.active }"
                    wdm-conversation>
                    <label class="wdmcr-a" ng-click="$root.GA('messages:select:' + status.selected)">
                        <input type="checkbox" ng-model="status.selected">
                    </label>
                    <div class="wdmcr-b" ng-class="{ multiple: c.addresses.length > 1 }">
                        <img ng-show="c.photo_path" ng-src="{{c.photo_path}}">
                    </div>
                    <div class="wdmcr-c">
                        <div class="wdmcr-c-a" ng-switch on="c.addresses.length">
                            <span ng-switch-default>{{ status.displayName() }}</span>
                            <span ng-switch-when="0">New message</span>
                        </div>
                        <div class="wdmcr-c-b">{{ c.snippet }}</div>
                    </div>
                    <div class="wdmcr-d">
                        <div class="status">&nbsp;
                            <i ng-show="c.has_error || hasFailedMsg(c)" class="wdmcr-icon-alert"></i>
                            <i ng-show="hasPendingMsg(c)" class="wdmcr-icon-running"></i>
                            <span class="badge" ng-show="c.unread_message_count">{{ c.unread_message_count }}</span>
                        </div>
                        <div>
                            {{ status.date() | messageDate:'MMM D' }}
                        </div>
                    </div>
                </li>
                <li wdm-load-more="prevConversations()" ng-hide="cvsLoaded"
                    ng-click="$root.GA('messages:load_conversations')"></li>
            </ol>
            <div class="wd-loading" data-visible="cvsListFirstLoading"></div>
        </section>
        <section class="wdm-main">
            <section class="wdm-contact">
                <div ui-if="activeConversation.message_count > 0" class="wdmct-a"
                    title="{{ cvsCache.get(activeConversation).displayName() }}">
                    {{ cvsCache.get(activeConversation).displayName() }}
                </div>
                <div ui-if="activeConversation.message_count == 0" class="wdmct-c">
                    <div>{{$root.DICT.messages.LABEL_SEND_TO}}: </div>
                    <textarea wdm-receiver rows="1" placeholder="{{$root.DICT.messages.RECEIVER_PLACEHOLDER}}"></textarea>
                </div>
            </section>
            <section class="wdm-entries" wdm-auto-scroll="cvsCache.get(activeConversation).messages">
                <div wdm-auto-scroll-container>
                    <div wdm-load-more="prevMessages(activeConversation)"
                        data-text="{{$root.DICT.messages.BTN_LOAD_MSG}}"
                        ng-hide="cvsCache.get(activeConversation).loaded || !activeConversation || cvsCache.get(activeConversation).messages.length == 0"
                        ng-click="$root.GA('messages:load_messages')"
                        style="width:120px;"></div>
                    <div ng-repeat="(d, g) in cvsCache.get(activeConversation).groups">
                        <div class="wdme-sep">
                            <span>{{ d | messageDate:'MMM D' }}</span>
                        </div>
                        <div class="wdme-row"
                            ng-class="{'wdme-row-self': m.type >= 2 && m.type <= 6}"
                            ng-repeat="m in g">
                            <div class="wdmer-a">{{ m.body }}</div>
                            <div class="wdmer-b" ng-switch on="m.status">
                                <span ng-switch-when="64"><i class="messages-icon-alert"></i> {{$root.DICT.messages.ERROR_SEND_FAILED}} <a href="" ng-click="resendMessage(m)">{{$root.DICT.messages.ACTION_RETRY}}</a></span>
                                <i ng-switch-when="32" class="messages-icon-running"></i>
                                <span class="wdmer-b-date" ng-switch-default>{{ m.date | messageDate:'HH:mm' }}</span>
                                <a href="" class="wdmer-b-del"
                                    ng-click="removeMessage(activeConversation, m);$root.GA('messages:delete_message')"><i class="messages-icon-ab-del"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="wdm-editor">
                <form ng-submit="sendMessage(activeConversation, sms)">
                    <textarea placeholder="{{ cvsCache.get(activeConversation).editorPlaceholder() }}" ng-model="sms" ng-disabled="!editorEnable" rows="1" wdm-textarea></textarea>
                    <button class="btn" type="submit" ng-click="$root.GA('message:send_click')">
                        <span>{{$root.DICT.messages.EDITOR_SUBMIT}}</span>
                    </button>
                </form>
            </section>
            <div class="wd-loading" data-visible="cvsChanging"></div>
        </section>
    </div>
</section>
