<section class="wdj-messages">
    <div class="wdm-layout">
        <section class="wdm-sub">
            <section class="wdm-actions">
                <button class="btn btn-primary"
                    ng-disabled="cvsListFirstLoading"
                    ng-click="createConversation();$root.GA('messages:create')"><i class="messages-icon-ab-add"></i> {{$root.DICT.messages.ACTION_NEW}}</button>
                <button class="btn"
                    ng-hide="cvsListFirstLoading"
                    ng-click="conversations.toggleSelectAll();$root.GA('messages:select_all:' + conversations.allSelected)"
                    ng-switch on="conversations.allSelected">
                    <i class="messages-icon-ab-sel"></i>
                    <span ng-switch-when="false">{{$root.DICT.messages.ACTION_SELECT_ALL}}</span>
                    <span ng-switch-when="true">{{$root.DICT.messages.ACTION_DESELECT_ALL}}</span>
                </button>
                <button class="btn"
                    ng-click="removeSelected();$root.GA('messages:delete_conversation')"
                    ng-show="conversations.hasSelected"><i class="messages-icon-ab-del"></i> {{$root.DICT.messages.ACTION_DELETE}}</button>
            </section>
            <div class="wdm-search">
                <div class="wdms-container">
                    <i class="messages-icon-search"></i>
                    <input type="text" placeholder="{{$root.DICT.messages.SEARCH_PLACEHOLDER}}..." ng-model="searchQuery">
                    <span class="clear" ng-show="searchQuery" ng-click="clearSearch()">&times;</span>
                </div>
            </div>
            <ol class="wdm-conversations unstyled">
                <li class="wdmc-row"
                    ui-animate11
                    ng-repeat="c in conversations.collection"
                    ng-class="{ selected: c.selected, highlight: c == activeConversation }"
                    wdm-conversation>
                    <label class="wdmcr-a"
                        ng-click="$root.GA('messages:select:' + c.selected)">
                        <span bs-tooltip="{{ selectTip(c) }}">
                            <input type="checkbox" ng-model="c.selected">
                        </span>
                    </label>
                    <div class="wdmcr-b" ng-class="{ multiple: c.multiple }">
                        <img ui-if="!c.multiple && c.photo_path" ng-src="{{c.photo_path}}">
                    </div>
                    <div class="wdmcr-c">
                        <div class="wdmcr-c-a" ng-switch on="c.addresses.length">
                            <span ng-switch-default>{{ c.displayNames.join(', ') }}</span>
                            <span ng-switch-when="0">New message</span>
                        </div>
                        <div class="wdmcr-c-b">{{ c.snippet }}</div>
                    </div>
                    <div class="wdmcr-d">
                        <div class="status">&nbsp;
                            <span ng-show="c.hasError"><i class="wdmcr-icon-alert"></i></span>
                            <span ui-if="c.hasPending"><i class="wdmcr-icon-running"></i></span>
                            <span class="badge" ng-show="c.unreadMessageCount">{{ c.unreadMessageCount }}</span>
                        </div>
                        <div>
                            {{ c.date | messageDate:'MMM D' }}
                        </div>
                    </div>
                </li>
                <li wdm-load-more="conversations.fetch()"
                    ng-hide="conversations.loaded || cvsListFirstLoading || isSearching()"
                    ng-click="$root.GA('messages:load_conversations')"></li>

                <li class="wdmc-ph" ui-if="isSearching() && conversations.loading">
                    <span class="wd-loading wd-loading-inline" data-visible="true"></span>
                </li>

                <li class="wdmc-row"
                    ui-if="isSearching() && !conversations.loading && conversations.empty">
                    <div style="margin:0 auto;">{{ $root.DICT.messages.SEARCH_BLANK_TIP }}</span>
                </li>

                <li wdm-load-more="conversations.searchContent()"
                    data-text="{{$root.DICT.messages.SEARCH_TIP.replace('$$', searchQuery.trim())}}"
                    ui-if="isSearching() && !conversations.loading"></li>
            </ol>
            <div class="wd-loading" data-visible="cvsListFirstLoading"></div>
        </section>
        <section class="wdm-main">
            <section class="wdm-contact">
                <div ui-if="!activeConversation.isNew" class="wdmct-a">
                    <span
                        ng-repeat="a in activeConversation.addresses"
                        bs-tooltip="{{a}}" data-options="{placement: 'bottom'}">
                        {{ activeConversation.contact_names[$index] || a }}
                        <span ng-hide="$last">, </span>
                    </span>
                </div>
                <div ui-if="activeConversation.isNew" class="wdmct-c">
                    <div>{{$root.DICT.messages.LABEL_SEND_TO}}: </div>
                    <textarea wdm-receiver rows="1"></textarea>
                </div>
            </section>

            <section class="wdm-results"
                ui-if="isSearching() && activeConversation.results">
                {{activeConversation.index}} ,
                {{activeConversation.length}}
                <span ui-if="activeConversation.hasPrevious()" ng-click="activeConversation.previous()">prev</span>
                <span ui-if="activeConversation.hasNext()" ng-click="activeConversation.next()">next</span>
            </section>

            <section class="wdm-entries" wdm-auto-scroll="activeConversation.messages.collection">
                <div wdm-auto-scroll-container>
                    <div class="wdme-load-more">
                        <div wdm-load-more="activeConversation.messages.fetch()"
                            data-pre="this.$emit('wdm:autoscroll:prekeep')"
                            data-post="this.$emit('wdm:autoscroll:keep')"
                            data-text="{{$root.DICT.messages.BTN_LOAD_MSG}}"
                            ng-hide="activeConversation.messages.loaded || !activeConversation || activeConversation.messages.length == 0"
                            ng-click="$root.GA('messages:load_messages')"></div>
                    </div>
                    <div class="wdme-block" ui-animate
                        ng-repeat="m in activeConversation.messages.collection"
                        >
                        <div class="wdme-sep" ui-if="m.isSeparator"><span>{{ m.date | date:'MMM d' }}</span></div>
                        <div class="wdme-row"
                            ng-class="{'wdme-row-self': m.type >= 2 && m.type <= 6, 'wdme-row-highlight': activeConversation.messages.isCursor(m)}">
                            <div class="wdmer-a">
                                <div class="wdmer-a-a"
                                    ng-show="m.type >= 2 && m.type <= 6 && activeConversation.addresses.length > 1">
                                    {{$root.DICT.messages.BATCH_RECEIVER_TIP}}
                                    <span bs-tooltip="{{m.address}}">{{ m.contact_name || m.address }}</span>:
                                </div>
                                <div ui-if="m.isSMS" class="wdmer-a-b">{{ m.body }}</div>
                                <div ui-if="m.isMMS" class="wdmer-a-b" style="color:#999;">{{ $root.DICT.messages.MMS_WARNING }}</div>
                            </div>
                            <div class="wdmer-b">
                                <span ui-if="m.isError"><i class="messages-icon-alert"></i> {{$root.DICT.messages.ERROR_SEND_FAILED}} <a href="" ng-click="resendMessage(activeConversation, m)">{{$root.DICT.messages.ACTION_RETRY}}</a></span>
                                <i ui-if="m.isPending" class="messages-icon-running"></i>
                                <span class="wdmer-b-date" ui-if="!m.isError && !m.isPending">{{ m.date | messageDate:'HH:mm' }}</span>
                                <a href="" class="wdmer-b-del"
                                    ng-show="!m.isPending"
                                    bs-tooltip="{{$root.DICT.messages.ACTION_DELETE}}"
                                    ng-click="removeMessage(activeConversation, m);$root.GA('messages:delete_message')"><i class="messages-icon-ab-del"></i></a>
                            </div>
                        </div>
                    </div>

                    <div class="wdme-load-more" ui-if="activeConversation.messages.isSearchResult">
                        <div wdm-load-more="activeConversation.messages.fetchLater()"
                            data-pre="this.$emit('wdm:autoscroll:prekeep')"
                            data-post="this.$emit('wdm:autoscroll:keep')"
                            data-text="{{$root.DICT.messages.BTN_LOAD_MSG}}"
                            ng-hide="activeConversation.messages.laterLoaded || !activeConversation || activeConversation.messages.length == 0"
                            ng-click="$root.GA('messages:load_messages')"></div>
                    </div>
                </div>
            </section>
            <section class="wdm-editor" ng-hide="cvsChanging || cvsListFirstLoading">
                <form ng-submit="sendMessage(activeConversation)">
                    <textarea rows="1"
                        ng-model="activeConversation.draft"
                        wdm-textarea
                        data-placeholder="{{ editorPlaceholder(activeConversation) }}"></textarea>
                    <button class="btn" type="submit" ng-click="$root.GA('message:send_click')"
                        bs-tooltip="{{$root.DICT.messages.BTN_SEND_TIP}}"
                        ng-disabled="!activeConversation.draft"
                        ng-class="{ 'btn-primary': activeConversation.draft}">
                        <span>{{$root.DICT.messages.EDITOR_SUBMIT}}</span>
                    </button>
                </form>
            </section>
            <div class="wd-loading" data-visible="cvsChanging || cvsListFirstLoading"></div>
        </section>
    </div>
    <div class="wd-blank" ui-if="!conversationsCache.length && !cvsListFirstLoading">
        <p>{{$root.DICT.messages.BLANK_TIP}}<p>
        <div class="btn btn-primary"
            ng-click="createConversation();$root.GA('messages:create')"><i class="messages-icon-ab-add"></i> {{$root.DICT.messages.ACTION_NEW}}</div>
    </div>
    <div ui-if="!serverMatchRequirement" class="wd-upgrade-warning" data-text="{{$root.DICT.messages.UPGRADE_TIP}}"></div>
</section>
